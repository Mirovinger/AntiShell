<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html> <!--<![endif]-->

<head>
	<meta charset="windows-1251">
	<title>Установка ZEOS+</title>
	<meta name="viewport" content="width=device-width">
	<link href="http://fonts.googleapis.com/css?family=Ubuntu+Condensed&subset=latin,cyrillic" rel="stylesheet">
	<style>
		/*Общие стили*/
		html{background: #bdc3c7 url('data:image/png;base64,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') repeat;}
		body{width: 960px;padding: 20px;margin: 20px auto;font:normal 14px/18px Arial, Helvetica, sans-serif;background: #f1f1f1;box-shadow: 0 0 15px 0 rgba(0, 0, 0, 0.1);color: #34495e;}
		::-moz-selection {background: #34495e;color: #f1f1f1;text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);}
		::selection {background: #34495e;color: #f1f1f1;text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);}
		hr{margin: 18px 0;border: 0;border-top: 1px solid #f5f5f5;border-bottom: 1px solid #bdc3c7;}
		.preview  {display: block;margin: 20px auto 40px;max-width: 100%;}
		.descr  {font: normal 18px/24px "Trebuchet MS", Arial, Helvetica, sans-serif;color: #34495e;margin: 20px -20px;padding: 20px;background: #ecf0f1;-webkit-box-shadow: inset 0 10px 10px -10px rgba(0, 0, 0, 0.1), inset 0 -10px 10px -10px rgba(0, 0, 0, 0.1);box-shadow: inset 0 10px 10px -10px rgba(0, 0, 0, 0.1), inset 0 -10px 10px -10px rgba(0, 0, 0, 0.1);text-shadow: 0 1px 0 #fff;}
		b{color: #2980b9;}
		.descr hr  {margin: 18px -20px;}
		.ta-center  {text-align: center;}
		.logo{margin: 0 auto;display: block;}
		a{color: #2980b9;}
		a:hover{text-decoration: none;color: #c0392b;}
		.btn, a.btn{line-height: 32px;font-size: 100%;margin: 0;vertical-align: baseline;*vertical-align: middle;cursor: pointer;*overflow: visible;background: #3498db;color: #ecf0f1;text-shadow: 0 1px 0 rgba(0, 0, 0, 0.2);border: 0;-webkit-border-radius: 3px;-moz-border-radius: 3px;border-radius: 3px;padding: 0 15px;display: inline-block; text-decoration: none; border-bottom: solid 3px #2980b9;}
		.btn:hover, a.btn:hover, .btn.active{background: #e74c3c; border-bottom-color: #c0392b}
		article,
		.gray{color: #95a5a6;}
		.green{color: #16a085;}
		.red{color: #c0392b;}
		.blue{color: #3498db;}
		h1, h2, h3, h4, h1 b, h2 b, h3 b, h4 b{font-family: 'Ubuntu Condensed', sans-serif;font-weight: normal;}
		h3{margin: 0;}
		h1{line-height: 20px;line-height: 28px;}
		.clr{clear: both;height: 0;overflow: hidden;}
		li{margin-bottom: 20px;color: #2980b9;}
		li li{margin-bottom: 4px;margin-top: 4px;}
		li.div, li li, li h3{color: #34495e;}
		textarea{width: 800px;margin-bottom: 10px;vertical-align: top;-webkit-transition: height 0.2s;-moz-transition: height 0.2s;transition: height 0.2s;outline: none;display: block;color:#f39c12;padding: 5px 10px;font: normal 14px/20px Consolas,'Courier New',monospace;background-color: #2c3e50;white-space: pre;white-space: pre-wrap;word-break: break-all;word-wrap: break-word;text-shadow: none;border: none; border-left: solid 3px #f39c12; }
		textarea:focus{background: #bdc3c7;border-color: #2980b9; color:#2c3e50;}
		input[type="text"] {padding: 4px 10px;width: 250px;vertical-align: middle;height: 24px;line-height: 24px;border: solid 1px #95a5a6;display: inline-block;-webkit-border-radius: 3px;-moz-border-radius:3px;border-radius: 3px;}
		input[type="text"]:focus {border-color: #3498db;color:#2c3e50;outline: none;-webkit-box-shadow: 0 0 0 3px rgba(41, 128, 185, .5);-moz-box-shadow: 0 0 0 3px rgba(41, 128, 185, .5);box-shadow: 0 0 0 3px rgba(41, 128, 185, .5);}
		.form-field {margin-bottom: 18px; margin-left: 90px;}
		.lebel {float: left;width: 300px;padding-right: 10px;line-height: 32px; text-align: right;}
		.control {width: 322px;float: left;}
		.control input[type="text"] { width: 300px; margin-bottom: 2px; }
		.clearfix:before, .clearfix:after {content: ""; display: table;}
		.clearfix:after {clear: both;}
		.clearfix {*zoom: 1;} 
	</style>
	<!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

</head>
<body>
	<header>
		<h1 class="ta-center"><big class="red">ZEOS+</big> <br><span class="blue">Мастер настройки и установки скрипта "ZEOS антивирус"</span></h1>
		<hr>
	</header>
	<section>  
		<h2 class="gray ta-center">Написан специально для быстрой установки антивируса на сайт без лишних заморочек.</h2>
		<?php
			$output = zeos_plus_installer();
			echo $output;
		?>

	</section> 	
	<p>Установщик подготовил: <a href="http://pafnuty.name/" target="_blank">ПафНутиЙ</a></p>
	<p>Сайт антивируса: <a href="http://zeos.in/" target="_blank">zeos.in</a></p>
	<p>Единственная статья с описанием: <a href="http://dle-news.ru/modules/1058-zeos-antivirus.html" target="_blank">dle-news.ru</a></p>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script>
		function generatePassword() {
			var length = 8,
				charset = "abcdefghijklnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
				retVal = "";
			for (var i = 0, n = charset.length; i < length; ++i) {
				retVal += charset.charAt(Math.floor(Math.random() * n));
			}
			return retVal;
		}
		jQuery(document).ready(function($) {
			$('input[name="password"]').val(generatePassword());
			$('#more_pass').click(function(event) {
				$('input[name="password"]').val(generatePassword());
			});
		});
	</script>
</body>
</html>

<?php 
	function zeos_plus_installer() {

		// Стандартный текст
		$output = '';
		
		// Если через $_POST передаётся параметр install, производим инсталляцию, согласно параметрам
		if(!empty($_POST['install'])) {

			// Определяем переменные
			$docroot = $_POST['docroot'];
		    $script_filename = $_POST['script_filename'];
		    $sitename = $_POST['sitename'];
		    $path = $_POST['path'];
		    $snapfile = $_POST['snapfile'];
		    $ext = $_POST['ext'];
		    $exclfiles = $_POST['exclfiles'];
		    $excldirs = $_POST['excldirs'];
		    $yourmail = $_POST['yourmail'];
		    $from = ($_POST['from']) ? $_POST['from'] : "" ;
		    $password = $_POST['password'];
		    $mt = $_POST['mt'];

		    // Текст скрипта ZEOS-антивирус (взят оригинальные код, пропущен через http://beta.phpformatter.com/ и подставлены переменные из формы. а так же добавлена переменная для email отправителя.)
			$zeos = '<?php
				/*
					=====================================================
					ZEOS ANTIVIRUS - Антивирус для сайта
					-----------------------------------------------------
					Сайт: http://zeos.in/
					-----------------------------------------------------
					По всем вопросам обращайтесь на: zeos.ua@gmail.com
					=====================================================
					Доработка скрипта: ПафНутиЙ (http://pafnuty.name/)
					-----------------------------------------------------
				*/

				////////////////////////////////////////////////////////////////////////////////

				// 0 - Выключить, 1 - Включить.
				$mode            = 1;

				// Путь к корню сайта.
				$docroot         = "'.$docroot.'";

				// Путь к файлу антивируса от корня сайта.
				$script_filename = "'.$script_filename.'";

				// Название сайта.
				$sitename        = "'.$sitename.'";

				// Начальный путь проверки. "/" - корень сайта. Например, нам надо сканировать не все, что есть на сервере, а только: http://zeos.in/forum/
				// Для этого указываем так: $path = "/forum";
				$path            = "'.$path.'";

				// Название файла со снимком системы. Путь от корня сайта. Директория должна существовать и иметь права CHMOD - 777
				// В целях безопасности мы рекомендуем переименовать файл на любое другое название с любым расширением и прописать путь в какую-то глубокую, отдаленную от корня папку.
				$snapfile        = "'.$snapfile.'";

				// Список расширений файлов, которые необходимо проверять. "*" или "" - означает любые расширения. Расширения указывать без точек и через символ: |
				// Например, $ext = "php|cgi|pl|perl|php3|php4|php5|php6|tpl|js|htaccess|htm|html|css|swf|txt|db|lng";
				$ext             = "'.$ext.'";

				// Список расширений файлов, которые не надо учитывать при проверке. Расширения указывать без точек и через символ: |
				// А также можно указывать имена файлов, которые тоже не надо учитывать. Например, $exclfiles = "index.php|jpg"; - здесь не будут учитываться файлы с именами "index.php" и все файлы с расширением JPG
				$exclfiles       = "'.$exclfiles.'";

				// Список папок, которые не надо проверять. Путь указывается относительно значения переменной "$path". Разделитель папок символ: |
				// Например, $excldirs = "/folder|/files/web"; - здесь папки: http://zeos.in/folder и http://zeos.in/files/web сканер будет пропускать.
				$excldirs        = "'.$excldirs.'";

				// Укажите адрес электронной почты. Можно указать несколько через разделитель: |
				$yourmail        = "'.$yourmail.'";
				
				// Укажите адрес с которого будет отправлено письмо. Если оставить пустым - будет использован первый адрес из переменной $yourmail.
				$from            = "'.$from.'";

				// Пароль для создания снимка системы. Если Вы хотите запретить запуск антивируса по ссылке "http://Ваш_домен/путь_к_файлу_антивируса/название_файла_антивируса.php?mode=2&pass=1234567" то закомментируйте строчку, поставив перед ней два символа: //
				$password        = "'.$password.'";

				// Лимит времени на выполнение скрипта.
				$mt              = '.$mt.';

				////////////////////////////////////////////////////////////////////////////////
				////////////////////// НЕ ТРОГАЙТЕ ЕСЛИ НЕ ШАРИТЕ!!! ///////////////////////////
				////////////////////////////////////////////////////////////////////////////////
				@error_reporting(0); // 2047 или E_ALL - вывод всех возможных ошибок.
				if ($mode == 0)
					die();
				$docroot         = checkpath(trim($docroot));
				$script_filename = $docroot . checkpath(trim($script_filename));
				$allfiles        = 0;
				$timelimit       = "";
				if (!isset($mt) || trim($mt) == "")
					$mt = 0;
				if ($mt != 0)
					$mt = $mt - 2;
				function dirListing($dir)
				{
					global $exclfiles, $excldirs, $ext, $snapfile, $mt, $st, $timelimit, $allfiles, $docroot, $script_filename;
					$exclfiles = midtrim($exclfiles);
					$excldirs  = midtrim($excldirs);
					$excldirs  = checkpath($excldirs);
					$ext       = midtrim($ext);
					$sfile     = explode("/", $snapfile);
					$sfile     = $sfile[count($sfile) - 1];
					if ($handle = opendir($dir)) {
						while (false !== ($file = readdir($handle))) {
							if ($file != "." && $file != "..") {
								if (is_dir($dir . "/" . $file)) {
									if (!preg_match("#" . $excldirs . "#i", $dir . "/" . $file) || $excldirs == "")
										@$snap .= dirListing($dir . "/" . $file);
								} //is_dir($dir . "/" . $file)
								else {
									if ((!preg_match("#" . $exclfiles . "#i", $file) || $exclfiles == "") && $file != $sfile && $file != $sfile . ".tmp" && $file != $sfile . ".pid" && $dir . "/" . $file != $script_filename) {
										if (preg_match("#.*\.(" . $ext . ")#i", $file) || $ext == "") {
											$allfiles++;
											$s = filesize($dir . "/" . $file);
											$t = filemtime($dir . "/" . $file);
											$h = md5_file($dir . "/" . $file);
											@$snap .= $dir . "/" . $file . "|" . $s . "|" . $t . "|" . $h . "\n";
											$nt = date("U") - $st;
											if ($nt > $mt && $mt != 0) {
												$timelimit = "Некоторые файлы не были обработаны из-за превышения лимита времени (" . ($mt + 2) . " сек.)";
												return $snap;
											} //$nt > $mt && $mt != 0
										} //preg_match("#.*\.(" . $ext . ")#i", $file) || $ext == ""
									} //(!preg_match("#" . $exclfiles . "#i", $file) || $exclfiles == "") && $file != $sfile && $file != $sfile . ".tmp" && $file != $sfile . ".pid" && $dir . "/" . $file != $script_filename
								}
							} //$file != "." && $file != ".."
						} //false !== ($file = readdir($handle))
						closedir($handle);
					} //$handle = opendir($dir)
					return $snap;
				}
				function recSnap($snap, $istmp = false)
				{
					global $snapfile, $docroot;
					$file = $docroot . $snapfile;
					if ($istmp)
						$file .= ".tmp";
					$f = fopen($file, "w");
					fputs($f, $snap);
					fclose($f);
				}
				function checkSnap($snap)
				{
					global $snapfile, $docroot;
					recSnap($snap, true);
					$snap   = file_get_contents($docroot . $snapfile . ".tmp");
					$fsnap  = file_get_contents($docroot . $snapfile);
					$msnap  = md5($snap);
					$mfsnap = md5($fsnap);
					if ($msnap == $mfsnap) {
						@unlink($docroot . $snapfile . ".tmp");
						return 0;
					} //$msnap == $mfsnap
					else {
						$snaparr  = explode("\n", $snap);
						$fsnaparr = explode("\n", $fsnap);
						$diff     = array_diff($fsnaparr, $snaparr);
						$diff     = array_unique($diff);
						$err      = "";
						foreach ($diff as $e) {
							$e = explode("|", $e);
							$err .= $e[0] . "\n";
						} //$diff as $e
						$diff = array_diff($snaparr, $fsnaparr);
						foreach ($diff as $s) {
							$elems = explode("|", $s);
							if (strstr($fsnap, $elems[0])) {
								if (strstr($err, $elems[0] . "\n")) {
									$err = str_replace($elems[0] . "\n", "Изменен файл: " . $elems[0] . "\n", $err);
								} //strstr($err, $elems[0] . "\n")
							} //strstr($fsnap, $elems[0])
							elseif ($elems[0] != "") {
								$err .= "Добавлен файл: " . $elems[0] . "\n";
							} //$elems[0] != ""
						} //$diff as $s
						unset($diff);
						$err    = explode("\n", trim($err));
						$errors = "";
						foreach ($err as $e) {
							if (substr($e, 0, 1) != "И" && substr($e, 0, 1) != "Д" && $e != "")
								$errors .= "Удален файл: " . $e . "\n";
							else
								$errors .= $e . "\n";
						} //$err as $e
						unset($err);
						$errors = str_replace($docroot, "", $errors);
						@unlink($docroot . $snapfile . ".tmp");
						return $errors;
					}
				}
				function mailfromsite($buffer, $subject, $mail, $from_mail)
				{
					global $path, $docroot, $sitename;
					$sitepath   = str_replace($docroot, "", $path);
					$from_email = $from_mail;
					$email      = $mail;
					if (trim($sitename) != "")
						$from_email = mime_encode($sitename, "windows-1251") . " <" . $from_email . ">";
					else
						$from_email = "<" . $from_email . ">";
					$buffer  = str_replace("\r", "", $buffer);
					$headers = "From: " . $from_email . "\r\n";
					$headers .= "X-Mailer: ZEOS ANTIVIRUS\r\n";
					$headers .= "Content-Type: text/plain; charset=windows-1251\r\n";
					$headers .= "Content-Transfer-Encoding: 8bit\r\n";
					$headers .= "X-Priority: 1 (Highest)";
					return mail($email, mime_encode($subject, \'windows-1251\'), $buffer, $headers);
				}
				function mime_encode($text, $charset)
				{
					return "=?" . $charset . "?B?" . base64_encode($text) . "?=";
				}
				function midtrim($str)
				{
					$str = trim($str);
					while (strpos($str, "||"))
						$str = str_replace("||", "|", $str);
					if (substr($str, 0, 1) == "|")
						$str = substr($str, 1, strlen($str) - 1);
					if (substr($str, strlen($str) - 1, 1) == "|")
						$str = substr($str, 0, strlen($str) - 1);
					$str = explode("|", $str);
					$cs  = count($str);
					for ($i = 0; $i < $cs; $i++) {
						$str[$i] = trim($str[$i]);
					} //$i = 0; $i < $cs; $i++
					$str = implode("|", $str);
					return $str;
				}
				function checkpath($str)
				{
					$str = explode("|", $str);
					$cs  = count($str);
					for ($i = 0; $i < $cs; $i++) {
						if (substr($str[$i], 0, 1) != "/")
							$str[$i] = "/" . $str[$i];
						if (substr($str[$i], strlen($str[$i]) - 1, 1) == "/")
							$str[$i] = substr($str[$i], 0, strlen($str[$i]) - 1);
					} //$i = 0; $i < $cs; $i++
					$str = implode("|", $str);
					return $str;
				}
				class Thread
				{
					function RegisterPID($pidFile)
					{
						if ($fp = fopen($pidFile, \'w\')) {
							fwrite($fp, " ");
							fclose($fp);
							@chmod($pidFile, 0777);
							return true;
						} //$fp = fopen($pidFile, \'w\')
						return false;
					}
					function CheckPID($pidFile)
					{
						if (file_exists($pidFile))
							return true;
						return false;
					}
					function KillPID($pidFile)
					{
						if (file_exists($pidFile))
							@unlink($pidFile);
					}
				}
				header(\'Content-type: text/html; charset=windows-1251\');
				$thread = new Thread();
				if (trim($snapfile) == "")
					die("Название файла со снимком системы не может быть пустым!");
				$snapfile = checkpath($snapfile);
				if (file_exists($docroot . $snapfile . ".pid") && date("U") - filemtime($docroot . $snapfile . ".pid") > 86400)
					@unlink($docroot . $snapfile . ".pid");
				if ($mode != 0 && $mode != 1)
					die(\'Неправильный режим. Установите переменную $mode в 0 или 1\');
				if (isset($password)) {
					if (isset($_GET[\'mode\'])) {
						$vmode = $_GET[\'mode\'];
						if ($vmode == 2) {
							if (isset($_GET[\'pass\']))
								$pass = $_GET[\'pass\'];
							else
								$pass = "";
							if ($pass === $password)
								$mode = 2;
							else {
								print("<font color=\"red\">Неверный пароль!</font><br /><form method=\"get\"><input type=\"hidden\" name=\"mode\" value=\"2\"/>Введите пароль: <input type=\"password\" name=\"pass\"/><input type=\"submit\" value=\"Отправить\"/></form>");
								die();
							}
						} //$vmode == 2
						else
							die();
					} //isset($_GET[\'mode\'])
				} //isset($password)
				if ($ext == "*")
					$ext = "";
				$path     = checkpath($path);
				$spath    = explode("/", $snapfile);
				$snappath = "";
				$csn      = count($spath);
				for ($i = 1; $i < $csn - 1; $i++) {
					$snappath .= "/" . $spath[$i];
				} //$i = 1; $i < $csn - 1; $i++
				if (substr(sprintf(\'%o\', fileperms($docroot . $snappath)), -3) != 777 && $mode == 2)
					die("У Вас нет прав для записи файла: " . $snapfile);
				if ($thread->CheckPID($docroot . $snapfile . ".pid"))
					die("Антивирус уже запущен и выполняется, дождитесь окончания работы.");
				$thread->RegisterPID($docroot . $snapfile . ".pid");
				switch ($mode) {
					case \'1\':
						if (!file_exists($docroot . $snapfile))
							$res = "Файл со снимком системы не создан или удален. Запустите программу в режиме 2";
						else {
							$st   = date("U");
							$path = $docroot . $path;
							$snap = dirListing($path);
							$res  = checkSnap($snap);
							if ($timelimit != "")
								$res .= $timelimit;
							$et    = date("U");
							$wtime = $et - $st;
							if ($wtime == 0)
								$wtime = 1;
							if ($wtime > 60)
								$wtime = floor($wtime / 60) . " мин. " . ($wtime % 60);
						}
						if ($res === 0)
							echo "Различия не найдены | " . date("d.m.Y в H:i:s") . " | Время сканирования: " . $wtime . " сек. | Всего файлов: " . $allfiles;
						else {
							echo nl2br($res);
							$yourmail = midtrim($yourmail);
							$mails    = explode("|", $yourmail);
							$f_m = ($from != "") ? $from : $mails[0];
							foreach ($mails as $m) {
								mailfromsite($res, "На сайте изменены файлы", $m, $f_m);
							} //$mails as $m
						}
						$thread->KillPID($docroot . $snapfile . ".pid");
						break;
					case \'2\':
						$st   = date("U");
						$path = $docroot . $path;
						$snap = dirListing($path);
						recSnap($snap);
						unset($snap);
						$et    = date("U");
						$wtime = $et - $st;
						if ($wtime == 0)
							$wtime = 1;
						if ($wtime > 60)
							$wtime = floor($wtime / 60) . " мин. " . ($wtime % 60);
						$res = "Снимок системы записан в файл: " . $snapfile . " | " . date("d.m.Y в H:i:s") . " | Время сканирования: " . $wtime . " сек. | Всего файлов: " . $allfiles;
						if ($timelimit != "")
							$res .= "\n" . $timelimit;
						echo nl2br($res);
						$yourmail = midtrim($yourmail);
						$mails    = explode("|", $yourmail);
						$f_m = ($from != "") ? $from : $mails[0];
						foreach ($mails as $m) {
							mailfromsite($res, "Создан снимок системы", $m, $f_m);
						} //$mails as $m
						$thread->KillPID($docroot . $snapfile . ".pid");
						break;
				} //$mode
				////////////////////////////////////////////////////////////////////////////////
				?>
			';
			 
			$zeos_file = fopen($docroot.$script_filename, "w");
			fwrite($zeos_file, $zeos);
			fclose($zeos_file);
			chmod($docroot.$script_filename, 0755);

			$bsn = basename($script_filename);
			$pth = str_ireplace($bsn, '', $script_filename);
			
			if (!file_exists($docroot.$script_filename)) {
				$output .= '<div class="descr">';
				$output .= '<h2 class="red">Антивирус не установлен!</h2>' ;
				$output .= '<p>Скроее всего нет прав на запись файлов. Установите на папку <b class="red">'.$pth.'</b> права на запись: CHMOD 777. <br />И не забудьте вернуть обратно после успешной установки антивируса.</p>';
				$output .= '<a class="btn" href="'.$_SERVER["PHP_SELF"].'" title="Вернуться обратно">Вернуться обратно</a>';
				$output .= '</div>';
			} else {

				$output .= '<div class="descr">';
				$output .= '<h2 class="red">Установка завершена! Обязательно удалите файл установщика!</h2>';
				$output .= '<p>Теперь можно запускать создание снимка системы и донастраивать параметры в ручную. И не забудьте сохранить ссылки на запуск проверки и создание снимка системы, они вам понядобятся.</p>';
				$output .= '<p><a href="http://'.$_SERVER['HTTP_HOST'].$script_filename.'?mode=2&pass='.$password.'" target="_blank" title="Будет запушена процедура создания снимка системы по адресу: http://'.$_SERVER['HTTP_HOST'].$script_filename.'?mode=2&pass='.$password.'" class="btn">1: Создать снимок системы</a>';
				$output .= ' <a href="http://'.$_SERVER['HTTP_HOST'].$script_filename.'" target="_blank" title="Будет запущена проверка системы: http://'.$_SERVER['HTTP_HOST'].$script_filename.'" class="btn">2: Запустить проверку</a></p>';
				$output .= '<small class="red">Если вдруг размер снимка равен нулю или скрипт говорит, что добавлено 0 файлов, посавтьте на корневую папку сайта CMOD 755.</small></div>';
				$output .= '<h2>Команда для выполнения через cron <small>(Скопируйте её и вставьте в планировщик)</small>:</h2>';
				$output .= '<div class="descr">
					<div><input type="text" onclick="this.select();" style="width: 600px;" name="docroot" value="/usr/bin/php -f '.$docroot.$script_filename.'"></div>
					<small class="red">Путь к php (<code class="blue">/usr/bin/php</code>) у вас может отличаться!</small> <small class="gray">Проверьте корректность пути (можно уточнить в ТП хостинга).</small> <br />
					<p>Рекомендую ставить в планировщик минимум раз в сутки. Если ресурсы хостинга позволяют - раз в час. Так вы отловите зловредный код или просто изменения в файлах очеь быстро.</p>
				</div>';
				$output .= '</div>';
			}
		}

		// Если через $_POST ничего не передаётся, выводим форму для установки модуля
		else {
			// Вывод
			$max_execution_time = ini_get('max_execution_time');
			$docroot = $_SERVER["DOCUMENT_ROOT"];

			$site_title = 'Мой сайт';
			$site_mail = 'noname@site.ru';
			if (file_exists($docroot.'/engine/data/config.php')) {
				include_once $docroot.'/engine/data/config.php';
				$site_title = ($config['short_title']) ? $config['short_title'] : $config['home_title'];
				$site_mail = $config['admin_mail'];
			}

			$output .= <<<HTML
			<div class="descr">
				<form method="POST">            
					<input type="hidden" name="install" value="1">
				
					<div class="form-field clearfix">
						<div class="lebel">Путь к корню сайта</div>
						<div class="control">
							<input type="text" name="docroot" value="$docroot">
							<small class="gray">Определено автоматически. Меняйте это значение, если только знаете что делаете.</small>
						</div>
					</div>
				
					<div class="form-field clearfix">
						<div class="lebel">Максимальное время выполнения скрипта (сек.)</div>
						<div class="control">
							<input type="text" name="mt" value="$max_execution_time">
							<small class="gray">Определено автоматически, можно выставить меньше. Больше не ставьте, скрипт зависнет и положит сайт.</small>
						</div>
					</div>
					
					<div class="form-field clearfix">
						<div class="lebel">Путь к файлу антивируса от корня сайта</div>
						<div class="control">
							<input type="text" name="script_filename" value="/zeos.php">
							<small class="red">Обязательно изменить!</small>
							<small class="gray">Лучше всего засунуть очень глубоко, чтобы никто не нашёл. Так же настоятельно рекомендуется сменить имя файла на что-то нечитаемое. <br>К примеру так: <code>/engine/classes/min/lib/MrClay/Cli/4589566Gdty.php</code></small>
						</div>
					</div>
				
					<div class="form-field clearfix">
						<div class="lebel">Имя сайта</div>
						<div class="control">
							<input type="text" name="sitename" value="Zeos: $site_title">
							<small class="gray">Будет отображаться как тема письма.</small>
						</div>
					</div>

					<div class="form-field clearfix">
						<div class="lebel">Начальный путь проверки</div>
						<div class="control">
							<input type="text" name="path" value="/">
							<small class="gray">По умолчанию - корень сайта.</small>
						</div>
					</div>

					<div class="form-field clearfix">
						<div class="lebel">Название файла со снимком системы</div>
						<div class="control">
							<input type="text" name="snapfile" value="/uploads/posts/snap.jpg">
							<small class="red">Обязательно изменить путь, имя и расширение файла!</small> <br>
							<small class="gray">Папка, в которой будет создаваться снимок, должна иметь CHMOD 777</small>
						</div>
					</div>

					<div class="form-field clearfix">
						<div class="lebel">Расширения файлов, которые необходимо проверять</div>
						<div class="control">
							<input type="text" name="ext" value="*">
							<small class="gray">По умолчанию все файлы. Расширения указывать без точек и через символ: <span class="red">|</span></small>
						</div>
					</div>

					<div class="form-field clearfix">
						<div class="lebel">Расширения файлов, которые проверяться не будут</div>
						<div class="control">
							<input type="text" name="exclfiles" value="jpg|jpeg|gif|bmp|png|rar|zip|tmp|gz|xml|flv|exe|doc|pdf|avi|mp3|mp4|wmv|m4v|m4a|mov|3gp|f4v|3gp|mpg|mpeg">
							<small class="gray">Указана оптимальная настройка. Расширения указывать без точек и через символ: <span class="red">|</span></small>
						</div>
					</div>

					<div class="form-field clearfix">
						<div class="lebel">Список папок, которые не надо проверять</div>
						<div class="control">
							<input type="text" name="excldirs" value="/engine/cache">
							<small class="gray">Путь указывается относительно корня сайта. Разделитель папок символ: <span class="red">|</span></small>
						</div>
					</div>

					<div class="form-field clearfix">
						<div class="lebel">Email для уведомлений</div>
						<div class="control">
							<input type="text" name="yourmail" value="$site_mail">
							<small class="gray">Можно указать несколько через разделитель: <span class="red">|</span></small>
						</div>
					</div>

					<div class="form-field clearfix">
						<div class="lebel">Email отправителя</div>
						<div class="control">
							<input type="text" name="from" value="">
							<small class="gray">С этого адреса будет отправлено письмо. Если оставить пустым - письмо будет отправлено с первого адреса для уведомлений (из поля выше)</small>
						</div>
					</div>

					<div class="form-field clearfix">
						<div class="lebel">Пароль для создания снимка системы</div>
						<div class="control">
							<div class="clearfix">
								<input type="text" name="password" value="1234567" style="width: 160px; float: left;"> <span title="Сгенерировать другой пароль." id="more_pass" class="btn" style="float: right;">Ещё пароль</span>
							</div>
							<small class="gray">Пароль нужен для запуска создаия снимка системы, что бы любой пользователь не смог это сделать. Пароль сгенерировался автоматически.</small>
						</div>
					</div>

					<div class="form-field clearfix">
						<div class="lebel">&nbsp;</div>
						<div class="control">
							<button class="btn" type="submit" style="width:322px;">Установить антивирус на сайт!</button>
						</div>
					</div>
				
				
				</form>
			</div>
HTML;


		}

		// Функция возвращает то, что должно быть выведено
		return $output;
	}

?>	